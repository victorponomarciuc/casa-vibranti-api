name: Deploy Live

on:
  push:
    branches: [master]

jobs:
  deploy-live:
    runs-on: self-hosted

    steps:
      - name: Pre-clean workspace (fix EACCES)
        shell: bash
        run: |
          set -euxo pipefail

          WORKDIR="/home/deploy/actions-runner/_work/casa-vibranti-api/casa-vibranti-api"

          if command -v sudo >/dev/null 2>&1; then
            sudo chown -R deploy:deploy /home/deploy/actions-runner/_work || true
            sudo chmod -R u+rwX /home/deploy/actions-runner/_work || true
            sudo rm -rf "$WORKDIR/runtime" || true
            sudo rm -rf "$WORKDIR" || true
          else
            rm -rf "$WORKDIR/runtime" || true
            rm -rf "$WORKDIR" || true
          fi

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1

      - name: Fix docker state (remove conflicting manual containers)
        shell: bash
        run: |
          set -euxo pipefail
          docker rm -f casa-vibranti-api-db-1 || true
          docker rm -f casa-vibranti-api-web-1 || true
          docker compose --env-file .env.production down --remove-orphans || true

      - name: Build and Deploy
        shell: bash
        run: |
          set -euxo pipefail
          docker compose --env-file .env.production up -d --build --force-recreate --remove-orphans
          docker image prune -f
          docker builder prune -f
